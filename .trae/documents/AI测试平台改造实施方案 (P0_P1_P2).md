# AI 测试平台改造实施方案 (最终版)

基于专业评审意见及最新补充（Celery 状态跟踪），制定本实施计划。本计划遵循“**高价值优先、零风险上线**”原则，将任务划分为 P0/P1/P2 三个阶段。

## 📅 阶段 P0：核心架构与稳定性 (预计耗时：1-2 天)
**目标**：解决系统阻塞、资源泄露风险，实现任务异步化与可追踪。

### 1. 基础设施：Redis 共享连接池 (防连接爆炸)
*   **痛点**：防止 Celery Worker 和 FastAPI 进程耗尽 Redis 连接数。
*   **行动**：
    *   创建 `core/redis_pool.py`，实现 `ConnectionPool` 单例。
    *   修改 `main.py` (`lifespan`) 和 `celery_config.py` 共用此连接池。
    *   **验证**：`netstat` 监控 Redis 连接数稳定在 100 以内。

### 2. AI 核心：真异步改造 (提速关键)
*   **痛点**：同步调用卡死主线程，导致高并发下服务不可用。
*   **行动**：
    *   完善 `core/ai_client.py`，全面使用 `httpx.AsyncClient`。
    *   改造业务层（如 `modules/test_generation.py`）调用异步方法 `await generate_response_async`。
    *   **验证**：API 响应时间从 8s 降至 <1s (任务提交即返回)。

### 3. 任务队列：Celery 集成与状态跟踪 (新增)
*   **痛点**：长任务超时重复执行、任务状态黑盒。
*   **行动**：
    *   **配置优化**：应用 `visibility_timeout=1800` 和 `worker_prefetch_multiplier=1`。
    *   **状态接口**：新增 API `GET /api/tasks/{task_id}`，返回任务状态 (PENDING/STARTED/SUCCESS/FAILURE) 及进度。
    *   **Worker 部署**：启动独立 Worker 进程处理测试生成任务。
    *   **验证**：提交 5 分钟长任务，确认无重复执行，且能通过 API 查询到状态。

### 4. 资源管理：Playwright 浏览器池熔断
*   **痛点**：无限制启动浏览器导致服务器 OOM (内存溢出)。
*   **行动**：
    *   创建 `core/browser_pool.py`，实现带信号量 (`asyncio.Lock`) 的池化管理。
    *   添加熔断机制：当实例数 > 5 时直接报错或排队，保护服务器。
    *   **验证**：并发请求 10 次 UI 测试，确认浏览器实例不超过设定上限。

### 5. 前端：数据持久化 (用户体验)
*   **痛点**：刷新页面导致上传的文件丢失。
*   **行动**：
    *   引入 IndexedDB (使用 `idb` 库) 存储上传文件的元数据和状态。
    *   实现项目切换时的状态隔离与恢复。

---

## 📅 阶段 P1：成本优化与功能增强 (预计耗时：3-4 天)
**目标**：降低 AI 调用成本，提升 RAG 检索效果。

### 1. 成本控制：AI 动态路由
*   **策略**：简单任务 (<1000 字符) -> `qwen-turbo`；复杂任务 -> `qwen-plus`。
*   **行动**：完善 `select_model` 逻辑，并在业务层应用。

### 2. 知识库：ChromaDB MVP
*   **策略**：轻量级向量检索，避免重型部署。
*   **行动**：集成 `chromadb`，实现文档向量化与相似度检索。

### 3. 安全与限流：中间件栈
*   **行动**：配置 `SlowAPI` 限流，启用 `TrustedHost` 和 `CORS` 安全中间件。

---

## 📅 阶段 P2：运维与高可用 (预计耗时：1 周)
**目标**：自动化运维，数据归档。

### 1. 运维体系
*   **行动**：Docker 部署健康检查 (`healthcheck`)，自动回滚策略。

### 2. 数据归档
*   **行动**：测试结果自动归档到对象存储，定期清理本地缓存。

---

## 🛡️ 风险控制与验证标准 (P0 阶段)

| 指标 | 目标值 | 验证方法 |
| :--- | :--- | :--- |
| **API P99 延迟** | < 1.5 秒 | 使用 Locust 进行 10 并发压测 |
| **任务重复率** | < 0.1% | 模拟 100 个长任务执行 |
| **AI 调用成本** | 降低 65% | 统计路由日志中的 Turbo 模型占比 |
| **Redis 连接数** | < 200 | 监控高负载下的连接池状态 |

## 🚀 今日执行清单 (按优先级)

1.  **[Task 1] Redis 连接池与 Celery 配置**：打好底层地基，防止连接泄露。
2.  **[Task 2] AI 异步客户端改造**：释放 FastAPI 性能。
3.  **[Task 3] Celery 状态查询接口**：实现“任务状态跟踪”需求。
4.  **[Task 4] 浏览器池熔断机制**：保护服务器内存。

请确认是否立即开始执行 **Task 1: Redis 连接池与 Celery 配置**？